<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--During development turn off caching-->
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title></title>
    <link rel="stylesheet" href="https://appsforoffice.microsoft.com/fabric/1.0/fabric.min.css">


    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
   


    <script>
        var newheader="";
        var currentheader="";
        var heeadercolor="";
        var vketJson="";
        var scopnename="";
        var classname="";
        var sensename="";
        var scopeindex="";
        var scopeidindex="";
  
        const JsonUrl="https://gokhanalpan.github.io";
        // The initialize function must be run each time a new page is loaded
        (function () {
            Office.initialize = function (reason) {
                //If you need to initialize something you can do so here.
        //  getJsonData();
          if(Office.context.document.settings.get("currentheader"))
          {
              currentheader=Office.context.document.settings.get("currentheader");
            //  console.log("instant "+currentheader);
          } else
          {
             Office.context.document.settings.set("currentheader",currentheader);
             Office.context.document.settings.saveAsync(function(asyncResult){});   
            // console.log("instant2 "+currentheader);

          }
          
            };
        })();

        //Notice function needs to be in global namespace
        function writeText(messagex,event) {

       //     Office.context.ui.displayDialogAsync('https://vket.azurewebsites.net/HTML/Scope.html', { height: 30, width: 20 });

            //Consult Office.js API reference to see all you can do. This just shows the simplest action.

            Office.context.document.setSelectedDataAsync(messagex,

                function (asyncResult) {
                    var error = asyncResult.error;
                    if (asyncResult.status === "failed") {
                        //show error. Upcoming displayDialog API will help here.
                    }
                    else {
                        //show success.Upcoming displayDialog API will help here.
                    }
                });
            //Required, call event.completed to let the platform know you are done processing.
          //  console.log("completed");
            event.completed();
           
        
        }
   async function getJsonData()
    {
      if(Office.context.document.settings.get("vket"))
      {
        vketJson=(Office.context.document.settings.get("vket"));
        //console.log("vket varmış "+ vketJson);
//        await Office.context.document.setSelectedDataAsync("json alındı zaten"+vketJson);

      }
      else
      {
        let response = await fetch(JsonUrl+"/config.data");
        if  (response.ok)
          {
           vketJson = await response.json();
           Office.context.document.settings.set("vket",vketJson);
           await Office.context.document.settings.saveAsync(function(asyncResult){});
       // console.log("yeni json alındı "+vketJson);
  //        Office.context.document.setSelectedDataAsync("json alındı settings "+Office.context.document.settings.get("vket"));


     //load scopes to scopeList
  
     
          } else
          {
    console.error("http error : " + response.status);
          }
      }
  
}
  



        function yaz(event)
        {
           writeText("bunu yaz",event)
            
          event.completed();

            
        }
   
     async function addHeader() {
      await Word.run(async (context) => {
        console.log("addheader started");
     await readscope();
        
        console.log("readscope end");

        if(!Office.context.document.settings.get("sensename"))
        {
          console.log("sense name is null");
           Office.context.document.settings.set("sensename","Kişisel Veri İçermez");
           Office.context.document.settings.saveAsync(function(asyncResult){}); 


        }
        console.log(" new sendename checked "+Office.context.document.settings.get("sensename"));
         newheader=Office.context.document.settings.get("scopename")+' | '+Office.context.document.settings.get("classname") +' | '+Office.context.document.settings.get("sensename");  
        console.log("ch1-sett "+Office.context.document.settings.get("currentheader"));
        
        console.log("ch1 var "+currentheader);
         //   console.log(newheader);

        console.log("currentscopeprop check started");
       if(!Office.context.document.settings.get("currentscopeprop"))
       {
        if(!Office.context.document.settings.get("currentheader"))
        {
          context.document.sections
          .getFirst()
          .getHeader("Primary")
          .insertHtml(newheader, "Start");

        Office.context.document.settings.set("currentheader",newheader);
        Office.context.document.settings.saveAsync(function(asyncResult){});
        console.log("ch2-sett "+Office.context.document.settings.get("currentheader"));
        console.log("ch2 var "+currentheader);
         

        await context.sync();
        }
      } else
      {
        currentheader=Office.context.document.settings.get("currentscopeprop")+' | '+Office.context.document.settings.get("currentclassprop")+' | '+Office.context.document.settings.get("currentsenseprop");
        Office.context.document.settings.set("currentheader",currentheader);
        Office.context.document.settings.saveAsync(function(asyncResult){}); 
        await context.sync();
        console.log("ch3-sett "+Office.context.document.settings.get("currentheader"));
        console.log("ch3 var "+currentheader);
        
      }
      console.log("search started sense:"+Office.context.document.settings.get("sensename"));
        var mysections = context.document.sections;
        context.load(mysections);

        await context.sync();
        currentheader=(Office.context.document.settings.get("currentheader"));
        console.log("ch4-sett "+Office.context.document.settings.get("currentheader"));
        console.log("ch4 var "+currentheader);
        
       // console.log("CURRENT HEADER: "+(Office.context.document.settings.get("currentheader")));
        for (var ii = 0; ii < mysections.items.length; ii++) {
          console.log("sections loop");
          console.log("section length :"+ mysections.items.length);
          console.log("search string :" +Office.context.document.settings.get("curhdr") );
         var res= mysections.items[ii].getHeader("Primary").search(currentheader);

         console.log("search started");
         context.load(res);
              return context.sync().then(function ()
           {
             console.log("res ctx loaded");
             console.log("search found: " + res.items.length);
             console.log("curr header1 :"+currentheader);
             console.log("curr header 2: "+Office.context.document.settings.get("currentheader"));
             console.log("new header " +newheader);
             console.log("sense name: "+Office.context.document.settings.get("sensename"));
             for(var x=0;x<res.items.length;x++)
              {
               console.log("search : "+res.items.length);
               console.log("new header :"+newheader);
               console.log("current header: "+Office.context.document.settings.get("currentheader"));
               console.log('<p style="font-family: verdana;text-align:center;color: '+Office.context.document.settings.get("headercolor")+'" >'+newheader+'</p>');
                res.items[x].insertHtml('<p style="font-family: verdana;text-align:center;color: '+Office.context.document.settings.get("headercolor")+'" >'+newheader+'</p>',"Replace");
   //             console.log('<p style="font-family: verdana;color: '+heeadercolor+'" >'+newheader+'</p>');
                currentheader=newheader;
             
                console.log("after chnage curr header: "+ currentheader);
                console.log("after change new hder : "+ newheader);
                Office.context.document.settings.set("currentheader",currentheader);
              Office.context.document.settings.saveAsync(function(asyncResult){});   
              }
              
            insertproperty("VeriketScope",Office.context.document.settings.get("scopename"));
            insertproperty("VeriketClassification",Office.context.document.settings.get("classname"));
            
            insertproperty("VeriketSensitivity",Office.context.document.settings.get("sensename"));
            readscope();
     //           console.log("after change current header: "+currentheader);
           })
        }
     
       
      })
 
      
      

    }

   function cokgizliheader()
    {
      console.log("çok gizzli clicked");
      getJsonData().then(function(){
        console.log("çok gizli inside jsonget");
      //Office.context.document.setSelectedDataAsync("json alındı ulan"+vketJson);
        
       // console.log(Office.context.document.settings.get("currentheader")); 
        //Office.context.document.setSelectedDataAsync("json alındı ulan2 "+Office.context.document.settings.get("vket"));
   
      Office.context.document.settings.set("scopename","Veriket");
      Office.context.document.settings.set("classname","Çok Gizli");
    //todo get color from json data
      Office.context.document.settings.set("headercolor","rgb(237,28,36)");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
   console.log("çok gizli bef add header");
      addHeader();
      })
       
    


    }
   function gizliheader()
   {
    console.log(" gizzli clicked");

    getJsonData().then(function(){

      console.log("gizli indifr getjson");
    
     // newheader='Veriket | Gizli';
      //heeadercolor="rgb(256,201,14)";
      Office.context.document.settings.set("scopename","Veriket");
      Office.context.document.settings.set("classname","Gizli");
    //todo get color from json data
      Office.context.document.settings.set("headercolor","rgb(256,201,14)");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      console.log("befare add header gizli");

      addHeader();
      })

   }
   function dahiliheader()
   {
    console.log("çdahili clicked");

    getJsonData().then(function(){
      console.log("dahili indifr getjson");
   //   newheader = 'Veriket | Dahili';
    //  heeadercolor= "rgb(0,159,231)";
      Office.context.document.settings.set("scopename","Veriket");
      Office.context.document.settings.set("classname","Dahili");
    //todo get color from json data
      Office.context.document.settings.set("headercolor","rgb(0,159,231)");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      console.log("befare add header");
      addHeader();
      })
   }
   function genelheader()
   {
    console.log("genel clicked");

    getJsonData().then(function(){
      
    //  newheader = "Veriket | Genel";
     // heeadercolor = "rgb(195,195,195)";
      Office.context.document.settings.set("scopename","Veriket");
      Office.context.document.settings.set("classname","Genel");
    //todo get color from json data
      Office.context.document.settings.set("headercolor","rgb(195,195,195)");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      addHeader();
      })

   }

   //**sensitivity functions ***/////
   function kvicermezheader()
   {
     getJsonData().then(function(){
      Office.context.document.settings.set("sensename","Kişisel Veri İçermez");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      addHeader();


    })
   }

   function kvicerirheader()
   {
     getJsonData().then(function(){
      Office.context.document.settings.set("sensename","Kişisel Veri İçerir");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      addHeader();


    })
   }
   function onkvicerirheader()
   {
     getJsonData().then(function(){
      Office.context.document.settings.set("sensename","Özel Nitelikli Kişisel Veri İçerir");
      Office.context.document.settings.saveAsync(function(asyncResult){});   
      addHeader();


    })
   }   
//*****read props****///
async function readscope()
{
 await Word.run(async (context) =>
  {
    let properties = context.document.properties.customProperties;
 
   context.load(properties);
     return context.sync()
     .then(function()
 {
   properties.load("key","type","value");
   //console.log("prop length : "+ properties.items.length);
   for(var i=0;i<properties.items.length;i++)
     {
       if(properties.items[i].key=="VeriketScope")
        {

          Office.context.document.settings.set("currentscopeprop",returnscopename(properties.items[i].value));
          Office.context.document.settings.saveAsync(function(asyncResult){});   
          console.log("scope prop :" +Office.context.document.settings.get("currentscopeprop" ));
    
        }
       else if(properties.items[i].key=="VeriketClassification")
        {
          Office.context.document.settings.set("currentclassprop",returnclassname(properties.items[i].value));
          Office.context.document.settings.saveAsync(function(asyncResult){});   
          console.log("scope prop :" +Office.context.document.settings.get("currentclassprop" ));

        }
        else if(properties.items[i].key=="VeriketSensitivity")
        {
          Office.context.document.settings.set("currentsenseprop",returnsensename(properties.items[i].value));
          //Office.context.document.settings.set("sensename",properties.items[i].value);
         Office.context.document.settings.saveAsync(function(asyncResult){});   
         console.log("scope prop :" +Office.context.document.settings.get("currentsenseprop" ));

        }
     }
 })
  })
  
}
/////********add props**********/////////
async function insertproperty(PropName,PropValue)
{
  await Word.run(async (context) => {

                         if(PropName=="VeriketScope")
                         {
                           context.document.properties.customProperties.add(PropName,  returnscopeguid(PropValue));
                         } else if(PropName=="VeriketClassification")
                         {
                          context.document.properties.customProperties.add(PropName,  returnclassid(PropValue));

                         } else if (PropName=="VeriketSensitivity")
                         {
                          context.document.properties.customProperties.add(PropName,  returnsenseid(PropValue));

                         }

                    await context.sync();

                    console.log("Property added");
                    console.log(PropName+":"+PropValue);
                });
}


   //*******read from json ******/////

  function returnscopename(scopeid)
  {
    let myjson = Office.context.document.settings.get("vket");
    const data = myjson["Scopes"];
    for(var x=0;x<data.length;x++)
    {
      if(data[x].Id==scopeid)
       {
         break;
       }
    }
      console.log("id: "+scopeid+"= "+data[x].Name);
      scopeindex=x;
      return data[x].Name;
  }

  function returnclassname(classid)
  {
    console.log("si :"+scopeindex);
    let myjson = Office.context.document.settings.get("vket");
    const data = myjson["Scopes"][scopeindex]["Classifications"];
    for(var xx=0;xx<data.length;xx++)
      {
        if(data[xx].Id==classid)
         {
           break;
         }
      }
      console.log("classid :"+classid+" = "+data[xx].Name);
      return data[xx].Name;
  }
   function returnsensename(senseid)
   {
    let myjson = Office.context.document.settings.get("vket");
    const data = myjson["Sensitivities"];
    for(var yy=0;yy<data.length;yy++)
    {
      if(data[yy].Id==senseid)
       {
         break;
       }
    }
    console.log("senseid: "+senseid+" ="+data[yy].Name);
     return data[yy].Name;
   }



   function returnscopeguid(lscopnename)
   {
     
     let myjson = Office.context.document.settings.get("vket");
     console.log(myjson);
     const data=myjson["Scopes"];
     for(var i=0;i<data.length;i++)
     {
       if(data[i].Name==lscopnename)
       {
         break;
       }
     }
     console.log(data.length+" "+i+" "+data[0].Id+data[i].Name+" "+data[i].Description);
     scopeidindex=i;
     console.log(data[i].Id);
     return data[i].Id;
   }
  
    function returnclassid(lclassname)
    {
    let myjson = Office.context.document.settings.get("vket");
    const data = myjson["Scopes"][scopeidindex]["Classifications"];
    for(var z=0;z<data.length;z++)
     {
       if(data[z].Name==lclassname)
        {
          break;
        }
     }
     console.log("class name: "+lclassname+" id: "+data[z].Id);
     return data[z].Id;
    }

    function returnsenseid(lsensename)
    {
    let myjson = Office.context.document.settings.get("vket");
    const data = myjson["Sensitivities"];
    for(var t=0;t<data.length;t++)
     {
       if(data[t].Name==lsensename)
        {
          break;
        }
     }

     console.log("sense name: "+lsensename+" =:"+data[t].Id);
     return data[t].Id;
    }

    </script>
</head>
<body>
    Function file body is never displayed.
</body>
</html>